
require:
   spacecore2 ->
      cached-function, State, DependentState
   .directory ->
      Directory
   .file ->
      File
   .output ->
      Write, Delete, commit-all
   .util ->
      rename, Renamer
      task-function
   path

provide:
   cached-function
   task-function
   Directory, File
   rename, Renamer
   Write, Delete, commit-all
   Engage


default-options = {
   log = console.log
}

class Engage:
   constructor{@main-task, @root, @options = {=}} =
      @options = default-options & @options
      if String? @root:
         @root = Directory{@root}
   run{} =
      @state = State{@root}
      @dstate = DependentState{@state, @main-task, clobber-patch = false}
      @act{}
      @dstate.add-listener{-> @act{}}
   act{} =
      commit-all{@dstate.get{}, @options}
